
> 值轉換器允許在讀取或寫入資料庫時轉換屬性值。

### 設定值轉換器

[ValueConverter 類別](https://learn.microsoft.com/zh-tw/ef/core/modeling/value-conversions?tabs=data-annotations#the-valueconverter-class)

```C#
public class Rider
{
    public int Id { get; set; }
    public EquineBeast Mount { get; set; }
}

public enum EquineBeast
{
    Donkey,
    Mule,
    Horse,
    Unicorn
}

protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    modelBuilder
        .Entity<Rider>()
        .Property(e => e.Mount)
        .HasConversion(
	        //寫入至資料庫： `ModelClrType` 轉換成 `ProviderClrType`
            v => v.ToString(), 
            
            //從資料庫讀取： `ProviderClrType` 轉換成 。`ModelClrType`
            v => (EquineBeast)Enum.Parse(typeof(EquineBeast), v));
}
```

### 使用EF Core 內建的轉換器

[EF Core 內建的轉換器](https://learn.microsoft.com/zh-tw/ef/core/modeling/value-conversions?tabs=fluent-api#built-in-converters)

```C#
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    modelBuilder
        .Entity<Rider>()
        .Property(e => e.Mount)
        
        //指定ProviderClrType
        .HasConversion<string>();
}
```

也可直接明確指定資料庫數據行類型，即可達到相同的目的：
1. Data Annotation(資料註解)：
```C#
public class Rider2
{
    public int Id { get; set; }

    [Column(TypeName = "nvarchar(24)")]
    public EquineBeast Mount { get; set; }
}
```

2. Fluent API：
```C#
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    modelBuilder
    .Entity<Rider2>()
    .Property(e => e.Mount)
    .HasColumnType("nvarchar(24)");
}
```

### 大量設定值轉換器：
```C#
//<ModelClrType,ProviderClrType>
public class CurrencyConverter : ValueConverter<Currency, decimal>
{
    public CurrencyConverter()
        : base(
	        //寫入至資料庫： `ModelClrType` 轉換成 `ProviderClrType`
            v => v.Amount,
            
            //從資料庫讀取： `ProviderClrType` 轉換成 。`ModelClrType`
            v => new Currency(v))
    {
    }
}

protected override void ConfigureConventions(ModelConfigurationBuilder configurationBuilder)
{
	//針對Currency的屬性值設定值轉換器
    configurationBuilder
        .Properties<Currency>()
        .HaveConversion<CurrencyConverter>();
}
```

### 數據行 Facet 和對應提示

某些資料庫類型具有可修改數據儲存方式的 Facet。 包括：
- 小數點和日期/時間數據行的有效位數和小數字數
- 二進位和字串數據行的大小/長度
- 字串數據行的 Unicode

> 這些 Facet 可以針對使用值轉換器的屬性，以一般方式設定，而且會套用至轉換的資料庫類型。

舉例如下
從列舉轉換成字串時，可指定資料庫數據行應該是非 Unicode，並儲存最多 20 個字元：
1. 以一般方式設定
```C#
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    modelBuilder
        .Entity<Rider>()
        .Property(e => e.Mount)
        .HasConversion<string>() //指定ProviderClrType
        .HasMaxLength(20)
        .IsUnicode(false);
}
```

2. 或者明確建立轉換器時：
```C#
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    var converter = new ValueConverter<EquineBeast, string>(
        v => v.ToString(),
        v => (EquineBeast)Enum.Parse(typeof(EquineBeast), v));

    modelBuilder
        .Entity<Rider>()
        .Property(e => e.Mount)
        .HasConversion(converter) //明確指定轉換器
        .HasMaxLength(20)
        .IsUnicode(false);
}
```

[使用情境](https://learn.microsoft.com/zh-tw/ef/core/modeling/value-conversions?tabs=data-annotations#examples)
